#include <stdbool.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>

typedef uint8_t u8;
typedef struct {
	u8 b0;  u8 b1;  u8 b2;  u8 b3;
	u8 b4;  u8 b5;  u8 b6;  u8 b7;
	u8 b8;  u8 b9;  u8 b10; u8 b11;
	u8 b12; u8 b13; u8 b14; u8 b15;
} u128;
#define U128(B0, B1, B2, B3, B4, B5, B6, B7, B8, B9, B10, B11, B12, B13, B14, B15) \
	((u128) { B0, B1, B2, B3, B4, B5, B6, B7, B8, B9, B10, B11, B12, B13, B14, B15 })

void aes_do_decrypt(u128* key, u128* plain, u128* cipher);
void aes_do_encrypt(u128* key, u128* plain, u128* cipher);

static bool u128_eq(u128 l, u128 r);
static void u128_stderr_print(u128 x);
static void test(int, bool);
static u128 k, v, e;

int main(void) {
	k = U128(0x2B, 0x7E, 0x15, 0x16, 0x28, 0xAE, 0xD2, 0xA6, 0xAB, 0xF7, 0x15, 0x88, 0x09, 0xCF, 0x4F, 0x3C);

	v = U128(0x6B, 0xC1, 0xBE, 0xE2, 0x2E, 0x40, 0x9F, 0x96, 0xE9, 0x3D, 0x7E, 0x11, 0x73, 0x93, 0x17, 0x2A);
	e = U128(0x3A, 0xD7, 0x7B, 0xB4, 0x0D, 0x7A, 0x36, 0x60, 0xA8, 0x9E, 0xCA, 0xF3, 0x24, 0x66, 0xEF, 0x97);
	test(1, false);

	v = U128(0xAE, 0x2D, 0x8A, 0x57, 0x1E, 0x03, 0xAC, 0x9C, 0x9E, 0xB7, 0x6F, 0xAC, 0x45, 0xAF, 0x8E, 0x51);
	e = U128(0xF5, 0xD3, 0xD5, 0x85, 0x03, 0xB9, 0x69, 0x9D, 0xE7, 0x85, 0x89, 0x5A, 0x96, 0xFD, 0xBA, 0xAF);
	test(2, false);

	v = U128(0x30, 0xC8, 0x1C, 0x46, 0xA3, 0x5C, 0xE4, 0x11, 0xE5, 0xFB, 0xC1, 0x19, 0x1A, 0x0A, 0x52, 0xEF);
	e = U128(0x43, 0xB1, 0xCD, 0x7F, 0x59, 0x8E, 0xCE, 0x23, 0x88, 0x1B, 0x00, 0xE3, 0xED, 0x03, 0x06, 0x88);
	test(3, false);

	v = U128(0xF6, 0x9F, 0x24, 0x45, 0xDF, 0x4F, 0x9B, 0x17, 0xAD, 0x2B, 0x41, 0x7B, 0xE6, 0x6C, 0x37, 0x10);
	e = U128(0x7B, 0x0C, 0x78, 0x5E, 0x27, 0xE8, 0xAD, 0x3F, 0x82, 0x23, 0x20, 0x71, 0x04, 0x72, 0x5D, 0xD4);
	test(4, false);

	/*
	v = U128(0x3A, 0xD7, 0x7B, 0xB4, 0x0D, 0x7A, 0x36, 0x60, 0xA8, 0x9E, 0xCA, 0xF3, 0x24, 0x66, 0xEF, 0x97);
	e = U128(0x6B, 0xC1, 0xBE, 0xE2, 0x2E, 0x40, 0x9F, 0x96, 0xE9, 0x3D, 0x7E, 0x11, 0x73, 0x93, 0x17, 0x2A);
	test(5, true);

	v = U128(0xF5, 0xD3, 0xD5, 0x85, 0x03, 0xB9, 0x69, 0x9D, 0xE7, 0x85, 0x89, 0x5A, 0x96, 0xFD, 0xBA, 0xAF);
	e = U128(0xAE, 0x2D, 0x8A, 0x57, 0x1E, 0x03, 0xAC, 0x9C, 0x9E, 0xB7, 0x6F, 0xAC, 0x45, 0xAF, 0x8E, 0x51);
	test(6, true);

	v = U128(0x43, 0xB1, 0xCD, 0x7F, 0x59, 0x8E, 0xCE, 0x23, 0x88, 0x1B, 0x00, 0xE3, 0xED, 0x03, 0x06, 0x88);
	e = U128(0x30, 0xC8, 0x1C, 0x46, 0xA3, 0x5C, 0xE4, 0x11, 0xE5, 0xFB, 0xC1, 0x19, 0x1A, 0x0A, 0x52, 0xEF);
	test(7, true);

	v = U128(0x7B, 0x0C, 0x78, 0x5E, 0x27, 0xE8, 0xAD, 0x3F, 0x82, 0x23, 0x20, 0x71, 0x04, 0x72, 0x5D, 0xD4);
	e = U128(0xF6, 0x9F, 0x24, 0x45, 0xDF, 0x4F, 0x9B, 0x17, 0xAD, 0x2B, 0x41, 0x7B, 0xE6, 0x6C, 0x37, 0x10);
	test(8, true);
	*/

	puts("All OK");
	return 0;
}

static void test(int n, bool decrypt) {
	u128 g;

	if(decrypt)
		aes_do_decrypt(&k, &v, &g);
	else
		aes_do_encrypt(&k, &v, &g);

	if(!u128_eq(e, g)) {
		fprintf(stderr, "Test %d failed!\n", n);
		fputs("Expected ", stderr);
		u128_stderr_print(e);
		fputs("\n     Got ", stderr);
		u128_stderr_print(g);
		fputs("\n", stderr);
		exit(n);
	}
}

static bool u128_eq(u128 l, u128 r) {
	return l.b0 == r.b0
	    && l.b1 == r.b1
	    && l.b2 == r.b2
	    && l.b3 == r.b3
	    && l.b4 == r.b4
	    && l.b5 == r.b5
	    && l.b6 == r.b6
	    && l.b7 == r.b7
	    && l.b8 == r.b8
	    && l.b9 == r.b9
	    && l.b10 == r.b10
	    && l.b11 == r.b11
	    && l.b12 == r.b12
	    && l.b13 == r.b13
	    && l.b14 == r.b14
	    && l.b15 == r.b15;
}

static void u128_stderr_print(u128 x) {
	fprintf(stderr, "%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x",
		x.b0, x.b1, x.b2,  x.b3,  x.b4,  x.b5,  x.b6,  x.b7,
		x.b8, x.b9, x.b10, x.b11, x.b12, x.b13, x.b14, x.b15);
}
